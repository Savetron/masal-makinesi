ğŸ“š Masal Makinesi â€“ Cursor Build Guide

Purpose: Give Cursor AI clear, linear instructions & code standards so it can autocomplete, refactor and reason about the Masal Makinesi codebase efficiently.

â¸»

0 â–ª Repo Skeleton

masal-makinesi/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                # Vercel Edge Functions (TypeScript)
â”‚   â””â”€â”€ ios/                # SwiftUI iOS target
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ prompts/            # Prompt templates & guard rules (TS)
â”‚   â””â”€â”€ shared/             # Shared types (TS + Swift via Swiftâ€Generate)
â”œâ”€â”€ docs/                   # Architecture, ADRs, onboarding
â””â”€â”€ .github/workflows/      # CI pipelines (lint, test, deploy)

Cursor: create this tree first, scaffolding empty folders + README stubs.

â¸»

1 â–ª Global Coding Conventions

Layer	Language	Lint / Style	Testing
Backend	TypeScriptÂ ES2023	eslint@latest, 4â€‘space indent	Vitest, 90%+ critical fn coverage
iOS	Swift 5.9	swiftformat â€“swiftversion 5.9Â + swiftlint	XCTest, 60%+ VM coverage

	â€¢	Commit style: Conventional Commits (feat: api story route).
	â€¢	Branching: main â†’ prod, dev â†’ staging, feature branches PRâ€™d to dev.

â¸»

2 â–ª Secrets / Env

# .env.example (root)
GEMINI_API_KEY=
SUPABASE_URL=
SUPABASE_ANON_KEY=
JWT_SECRET=

Cursor: never commit real keys; use Vercel + Xcode Schemes.

â¸»

3 â–ª Milestone Roadmap & Task Breakdown

#	Component	Cursor Toâ€‘Dos (chronological)
M1	Monorepo Setup	init git, add pnpm workspace; Swift package manifest; CI lint job
M2	prompts/	storyPrompt.ts with templating fn; guard.ts blockâ€‘list + regex
M3	API /story	Edge handler: JWT auth â†’ build prompt â†’ call Gemini â†’ parse JSON â†’ store Supabase â†’ return 200 JSON
M4	API tests	Vitest suites: happy path, guard fail, moderation fail
M5	Deploy	Vercel project link, set env vars, smoke test curl
M6	iOS networking	NetworkManager (async/await) + JWT refresh; model structs mirrored from shared types
M7	SwiftUI Core Views	OnboardingWizard â†’ StoryListView â†’ StoryDetailView (TTS)
M8	State & Storage	Combineâ€‘based StoryStore (Supabase fetch + CoreData cache)
M9	RevenueCat Paywall	Configure offerings, PaywallView, entitlement check wrapper
M10	Auth	Signâ€‘inâ€‘withâ€‘Apple; anonymous fallback â†’ upgrade
M11	Unit + UI Tests	XCTest for VM logic, snapshot tests StoryListView
M12	Beta & Release	Fastlane TestFlight lane, CFBundleShortVersion bump script

Complete milestones sequentially; do not start next until CI green.

â¸»

4 â–ª Prompt & Safety Logic
	1.	Prompt builder merges StoryRequest â†’ template.
	2.	Run Gemini Safety Settings first (text-moderation-latest).
	3.	After LLM response, validate JSON schema (zod), word count, blockâ€‘list.
	4.	Retry with temperatureâ€‘0.7 once on schema error, else fail.

Cursor tip: keep guard util in packages/prompts/validate.ts for reuse.

â¸»

5 â–ª iOS Specific Guidelines
	â€¢	Use MVVM + Combine; no thirdâ€‘party reactive libs.
	â€¢	All blocking I/O (TTS generation) on background thread.
	â€¢	Localized strings in Localizable.strings (tr, en fallback).
	â€¢	Voice: AVSpeechSynthesisVoice(language: "tr-TR").
	â€¢	Cache TTS .m4a under FileManager.default.urls(.cachesDirectory).
	â€¢	Accessibility: Dynamic Type + VoiceOver labels.

â¸»

6 â–ª CI / CD
	â€¢	GitHub Actions
	â€¢	lint.yml â†’ eslint + swiftlint.
	â€¢	test.yml â†’ vitest + xcodebuild test.
	â€¢	deploy_api.yml â†’ on mainâ†’ Vercel deploy.
	â€¢	Fastlane lanes: beta, release; autoâ€‘increment build.

â¸»

7 â–ª Definition of Done (DoD)
	â€¢	Story API returns â‰¤ 4â€¯s P95 latency.
	â€¢	iOS app delivers ilk masal â‰¤ 10â€¯s from tap.
	â€¢	0 crash in 50 TestFlight sessions.
	â€¢	COPPA compliance checklist passed.

â¸»

Now playing: M1. Cursor, scaffold repo tree & CI, commit as chore: init monorepo. ğŸš€